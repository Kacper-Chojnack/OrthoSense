name: E2E Tests

on:
  push:
    branches: [main, develop, zosia]
  pull_request:
    branches: [main, develop, zosia]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.24.0'
  PYTHON_VERSION: '3.13'

jobs:
  # ============================================================================
  # Backend E2E Tests
  # ============================================================================
  backend-e2e:
    name: Backend E2E Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: orthosense_e2e_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install CPU-only torch to save space
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install ".[dev,ai-full]"

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Run E2E Tests (SQLite - Fast)
        env:
          SECRET_KEY: "e2e_test_secret_key_for_ci_only"
          DATABASE_URL: "sqlite+aiosqlite:///:memory:"
          RATE_LIMIT_ENABLED: "false"
        run: |
          pytest tests/e2e_api -v --tb=short -x

      - name: Run E2E Tests (PostgreSQL - Full)
        env:
          SECRET_KEY: "e2e_test_secret_key_for_ci_only"
          E2E_DATABASE_URL: "postgresql+asyncpg://postgres:testpass@localhost:5432/orthosense_e2e_test"
          DATABASE_URL: "postgresql+asyncpg://postgres:testpass@localhost:5432/orthosense_e2e_test"
          RATE_LIMIT_ENABLED: "false"
        run: |
          pytest tests/e2e_api -v --tb=short --cov=app --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage.xml
          flags: backend-e2e
          name: backend-e2e-coverage
        continue-on-error: true

  # ============================================================================
  # Backend E2E Tests (Existing tests in tests/e2e/)
  # ============================================================================
  backend-e2e-existing:
    name: Backend E2E Tests (Existing)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install ".[dev,ai-full]"

      - name: Run Existing E2E Tests
        env:
          SECRET_KEY: "e2e_test_secret_key_for_ci_only"
          DATABASE_URL: "sqlite+aiosqlite:///:memory:"
          RATE_LIMIT_ENABLED: "false"
        run: |
          pytest tests/e2e -v --tb=short

  # ============================================================================
  # Flutter E2E Tests
  # ============================================================================
  flutter-e2e:
    name: Flutter E2E Tests
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Run Flutter E2E Tests
        run: |
          flutter test test/e2e --verbose --reporter expanded
        continue-on-error: true  # E2E tests may fail in CI without emulator

      - name: Run Flutter E2E Tests with Coverage
        run: |
          flutter test test/e2e --coverage
        continue-on-error: true

      - name: Upload Flutter Coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: flutter-e2e
          name: flutter-e2e-coverage
        continue-on-error: true

  # ============================================================================
  # Flutter E2E Tests on Android Emulator
  # ============================================================================
  flutter-e2e-android:
    name: Flutter E2E Tests (Android)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Run E2E Tests on Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 31
          arch: x86_64
          profile: Nexus 6
          script: |
            flutter build apk --debug
            flutter test test/e2e --verbose
        continue-on-error: true

  # ============================================================================
  # E2E Test Summary
  # ============================================================================
  e2e-summary:
    name: E2E Test Summary
    needs: [backend-e2e, backend-e2e-existing, flutter-e2e]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check E2E Results
        run: |
          echo "Backend E2E: ${{ needs.backend-e2e.result }}"
          echo "Backend E2E (Existing): ${{ needs.backend-e2e-existing.result }}"
          echo "Flutter E2E: ${{ needs.flutter-e2e.result }}"

          if [[ "${{ needs.backend-e2e.result }}" == "failure" ]]; then
            echo "::error::Backend E2E tests failed"
            exit 1
          fi

          if [[ "${{ needs.backend-e2e-existing.result }}" == "failure" ]]; then
            echo "::error::Backend E2E (Existing) tests failed"
            exit 1
          fi

          # Flutter E2E is expected to potentially fail in CI
          if [[ "${{ needs.flutter-e2e.result }}" == "failure" ]]; then
            echo "::warning::Flutter E2E tests failed (may be expected in CI without device)"
          fi

          echo "E2E tests completed"
