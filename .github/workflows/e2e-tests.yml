# =============================================================================
# OrthoSense - E2E Tests Pipeline
# =============================================================================
# End-to-end testing for backend API and Flutter application
# =============================================================================

name: E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.38.0'
  PYTHON_VERSION: '3.13'

jobs:
  # ---------------------------------------------------------------------------
  # Job: Backend E2E Tests (SQLite)
  # ---------------------------------------------------------------------------
  backend-e2e-sqlite:
    name: Backend E2E Tests (SQLite)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install -e ".[dev]"

      - name: Run E2E Tests
        env:
          SECRET_KEY: "e2e_test_secret_key_for_ci"
          DATABASE_URL: "sqlite+aiosqlite:///:memory:"
          RATE_LIMIT_ENABLED: "false"
        run: pytest tests/e2e tests/e2e_api -v --tb=short

  # ---------------------------------------------------------------------------
  # Job: Backend E2E Tests (PostgreSQL)
  # ---------------------------------------------------------------------------
  backend-e2e-postgres:
    name: Backend E2E Tests (PostgreSQL)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        working-directory: backend

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: orthosense_e2e_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install -e ".[dev]"

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Run E2E Tests
        env:
          SECRET_KEY: "e2e_test_secret_key_for_ci"
          DATABASE_URL: "postgresql+asyncpg://postgres:testpass@localhost:5432/orthosense_e2e_test"
          RATE_LIMIT_ENABLED: "false"
        run: |
          pytest tests/e2e tests/e2e_api -v --tb=short \
            --cov=app \
            --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          files: ./backend/coverage.xml
          flags: backend-e2e
          fail_ci_if_error: false

  # ---------------------------------------------------------------------------
  # Job: Flutter E2E Tests
  # ---------------------------------------------------------------------------
  flutter-e2e:
    name: Flutter E2E Tests
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run E2E Tests
        run: flutter test test/e2e --coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/lcov.info
          flags: flutter-e2e
          fail_ci_if_error: false

  # ---------------------------------------------------------------------------
  # Job: E2E Test Summary
  # ---------------------------------------------------------------------------
  summary:
    name: E2E Test Summary
    needs: [backend-e2e-sqlite, backend-e2e-postgres, flutter-e2e]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check Results
        run: |
          echo "## ðŸ§ª E2E Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.backend-e2e-sqlite.result }}" == "success" ]]; then
            echo "| Backend E2E (SQLite) | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Backend E2E (SQLite) | âŒ ${{ needs.backend-e2e-sqlite.result }} |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.backend-e2e-postgres.result }}" == "success" ]]; then
            echo "| Backend E2E (PostgreSQL) | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Backend E2E (PostgreSQL) | âŒ ${{ needs.backend-e2e-postgres.result }} |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.flutter-e2e.result }}" == "success" ]]; then
            echo "| Flutter E2E | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Flutter E2E | âŒ ${{ needs.flutter-e2e.result }} |" >> $GITHUB_STEP_SUMMARY
          fi

          # All E2E tests must pass
          if [[ "${{ needs.backend-e2e-sqlite.result }}" != "success" ]] || \
             [[ "${{ needs.backend-e2e-postgres.result }}" != "success" ]] || \
             [[ "${{ needs.flutter-e2e.result }}" != "success" ]]; then
            echo ""
            echo "âŒ E2E tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo ""
          echo "âœ… All E2E tests passed" >> $GITHUB_STEP_SUMMARY
