# =============================================================================
# OrthoSense - Terraform Infrastructure Pipeline
# =============================================================================
# Plan and Apply Terraform changes with manual approval for production
# Uses GitHub OIDC for secure, keyless authentication
# =============================================================================

name: Infrastructure CI/CD

on:
  push:
    branches: [main]
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform.yml'
  pull_request:
    branches: [main]
    paths:
      - 'terraform/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      action:
        description: 'Terraform action'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy

# Cancel in-progress runs when a new run is triggered (except for manual dispatches)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name != 'workflow_dispatch' }}

env:
  AWS_REGION: eu-central-1
  TF_VERSION: '1.6.6'
  TF_VAR_secret_key: ${{ secrets.APP_SECRET_KEY }}

permissions:
  id-token: write
  contents: read
  pull-requests: write
  security-events: write

jobs:
  # ---------------------------------------------------------------------------
  # Job: Terraform Validate
  # ---------------------------------------------------------------------------
  validate:
    name: Validate
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Init (no backend)
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

  # ---------------------------------------------------------------------------
  # Job: Security Scan
  # ---------------------------------------------------------------------------
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [validate]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov
        id: checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform
          framework: terraform
          output_format: sarif
          output_file_path: checkov-results.sarif
          # Documented exceptions for this project's AWS configuration:
          # CKV_AWS_293: App Runner not using CMK (using AWS-managed encryption)
          # CKV_AWS_157: RDS multi-AZ disabled (dev/staging cost optimization)
          # CKV_AWS_338: CloudWatch log retention (project-specific retention policy)
          # CKV_AWS_158: CloudWatch logs not using CMK (using AWS-managed encryption)
          # CKV_AWS_51: ECR tag immutability (mutable tags needed for CI/CD)
          # CKV_AWS_300: WAF rules (configured at application level)
          # CKV_AWS_119: DynamoDB CMK (using AWS-managed encryption)
          # CKV_AWS_28: DynamoDB PITR (dev/staging cost optimization)
          # CKV_AWS_144: S3 cross-region replication (single-region deployment, cost optimization)
          # CKV_AWS_145: S3 KMS encryption (using AWS-managed SSE-S3)
          # CKV_AWS_18: S3 access logging (logs bucket doesn't need logging)
          # CKV_AWS_21: S3 versioning (not needed for all buckets)
          # CKV2_AWS_12: Default VPC security group (managed at security group level)
          # CKV2_AWS_61: ECR lifecycle policy (managed separately)
          # CKV2_AWS_62: ECR scanning (using Trivy in CI instead)
          skip_check: CKV_AWS_293,CKV_AWS_157,CKV_AWS_338,CKV_AWS_158,CKV_AWS_51,CKV_AWS_300,CKV_AWS_119,CKV_AWS_28,CKV_AWS_144,CKV_AWS_145,CKV_AWS_18,CKV_AWS_21,CKV2_AWS_12,CKV2_AWS_61,CKV2_AWS_62

      - name: Upload Checkov results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: success() && hashFiles('checkov-results.sarif') != ''
        with:
          sarif_file: checkov-results.sarif
          category: checkov-terraform

      - name: Security Scan Summary
        if: success()
        run: |
          echo "## ðŸ”’ Terraform Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Checkov security scan passed" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Job: Plan Dev
  # ---------------------------------------------------------------------------
  plan-dev:
    name: Plan (Dev)
    runs-on: ubuntu-latest
    needs: [validate, security]
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    defaults:
      run:
        working-directory: terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/orthosense-dev-github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -backend-config=environments/dev/backend.hcl

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -var-file=environments/dev/terraform.tfvars \
            -out=tfplan \
            -no-color 2>&1 | tee plan-output.txt

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-dev
          path: |
            terraform/tfplan
            terraform/plan-output.txt
          retention-days: 7

      - name: Comment Plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('terraform/plan-output.txt', 'utf8');
            const truncated = planOutput.length > 60000 
              ? planOutput.substring(0, 60000) + '\n\n... (truncated)'
              : planOutput;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Terraform Plan (Dev) ðŸ“‹\n\n<details><summary>Show Plan</summary>\n\n\`\`\`hcl\n${truncated}\n\`\`\`\n\n</details>`
            });

  # ---------------------------------------------------------------------------
  # Job: Apply Dev
  # ---------------------------------------------------------------------------
  apply-dev:
    name: Apply (Dev)
    runs-on: ubuntu-latest
    needs: [plan-dev]
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.environment == 'dev' && 
      github.event.inputs.action == 'apply'
    environment:
      name: dev
    defaults:
      run:
        working-directory: terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-dev
          path: terraform

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/orthosense-dev-github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -backend-config=environments/dev/backend.hcl

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

  # ---------------------------------------------------------------------------
  # Job: Plan Staging
  # ---------------------------------------------------------------------------
  plan-staging:
    name: Plan (Staging)
    runs-on: ubuntu-latest
    needs: [validate, security]
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'
    defaults:
      run:
        working-directory: terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/orthosense-staging-github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -backend-config=environments/staging/backend.hcl

      - name: Terraform Plan
        run: |
          terraform plan \
            -var-file=environments/staging/terraform.tfvars \
            -out=tfplan

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-staging
          path: terraform/tfplan
          retention-days: 7

  # ---------------------------------------------------------------------------
  # Job: Apply Staging
  # ---------------------------------------------------------------------------
  apply-staging:
    name: Apply (Staging)
    runs-on: ubuntu-latest
    needs: [plan-staging]
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.environment == 'staging' && 
      github.event.inputs.action == 'apply'
    environment:
      name: staging
    defaults:
      run:
        working-directory: terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-staging
          path: terraform

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/orthosense-staging-github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -backend-config=environments/staging/backend.hcl

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

  # ---------------------------------------------------------------------------
  # Job: Plan Production
  # ---------------------------------------------------------------------------
  plan-prod:
    name: Plan (Production)
    runs-on: ubuntu-latest
    needs: [validate, security]
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')
    defaults:
      run:
        working-directory: terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/orthosense-prod-github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -backend-config=environments/prod/backend.hcl

      - name: Terraform Plan
        run: |
          terraform plan \
            -var-file=environments/prod/terraform.tfvars \
            -out=tfplan

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-prod
          path: terraform/tfplan
          retention-days: 7

  # ---------------------------------------------------------------------------
  # Job: Apply Production (Manual Approval Required)
  # ---------------------------------------------------------------------------
  apply-prod:
    name: Apply (Production)
    runs-on: ubuntu-latest
    needs: [plan-prod]
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.environment == 'prod' && 
      github.event.inputs.action == 'apply'
    environment:
      name: prod
    defaults:
      run:
        working-directory: terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-prod
          path: terraform

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/orthosense-prod-github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -backend-config=environments/prod/backend.hcl

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

      - name: Notify Success
        if: success()
        run: echo "âœ… Production infrastructure updated successfully!"
