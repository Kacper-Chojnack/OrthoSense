security:
  runs-on: ubuntu-latest
  needs: test
  permissions:
    security-events: write  # Dla SARIF upload
  
  steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Dla secrets scanning

    - name: Semgrep (SAST)
      uses: semgrep/semgrep-action@v1[web:100]
      with:
        config: >-
          p/security-audit
          p/python
          p/secrets
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}  # Darmowy token

    - name: Bandit (Python SAST)
      run: |
        cd backend
        pip install bandit
        bandit -r app -f sarif -o bandit.sarif[web:107]
      continue-on-error: true

    - name: Safety (SCA deps)
      uses: pipenv/safety-action@v1[web:99]
      with:
        path: backend
      continue-on-error: true

    - name: Trivy (container scan - jeśli masz Docker)
      uses: aquasecurity/trivy-action@master[web:104]
      with:
        image-ref: 'backend-app'  # Zmień na Twój image
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload SARIF to GitHub
      uses: github/codeql-action/upload-sarif@v3[web:100]
      with:
        sarif_file: |
          bandit.sarif
          trivy-results.sarif
        category: backend-security
