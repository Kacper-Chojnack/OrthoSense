security:
  runs-on: ubuntu-latest
  needs: test
  permissions:
    security-events: write
  
  steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Semgrep (SAST)
      uses: semgrep/semgrep-action@v1[web:100]
      with:
        config: >-
          p/security-audit
          p/python
          p/secrets
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

    - name: Bandit (Python SAST)
      run: |
        cd backend
        pip install bandit
        bandit -r app -f sarif -o bandit.sarif[web:107]
      continue-on-error: true

    - name: Safety (SCA deps)
      uses: pipenv/safety-action@v1[web:99]
      with:
        path: backend
      continue-on-error: true

    - name: Upload SARIF to GitHub
      uses: github/codeql-action/upload-sarif@v3[web:100]
      with:
        sarif_file: |
          bandit.sarif
          trivy-results.sarif
        category: backend-security
