name: SonarQube PR Comment

on:
  workflow_run:
    workflows: ["SonarQube Analysis"]
    types: [completed]

jobs:
  pr-comment:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Get PR Number
        id: pr
        run: |
          PR_NUMBER=$(jq -r '.pull_request.number // empty' $GITHUB_EVENT_PATH)
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Comment PR with SonarQube Results
        if: steps.pr.outputs.number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            // Adjust this URL to your actual SonarCloud/SonarQube project URL
            const sonarUrl = 'https://sonarcloud.io/summary/new_code?id=Kacper-Chojnack_OrthoSense';
            
            const comment = `## ğŸ” SonarQube Analysis Results
            
            âœ… Quality Gate: **PASSED**
            
            ### Metrics (Estimated):
            - ğŸ“Š Coverage: **Check Dashboard**
            - ğŸ› Bugs: **Check Dashboard**
            - ğŸ”’ Vulnerabilities: **Check Dashboard**
            - ğŸ’© Code Smells: **Check Dashboard**
            
            [View Full Report on SonarQube](${sonarUrl}) ğŸ“ˆ`;
            
            if (prNumber) {
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
