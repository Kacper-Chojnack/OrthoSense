name: Integration Tests

on:
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * *' # Nightly at 2 AM
  workflow_dispatch:

jobs:
  e2e-test:
    name: Full Stack E2E
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Compose
        run: |
          docker compose -f config/docker/docker-compose.yml build backend
          docker compose -f config/docker/docker-compose.yml up -d backend db redis

      - name: Wait for Backend Health
        run: |
          timeout 120s bash -c 'until curl -sf http://localhost:8000/health; do echo "Waiting for backend..."; sleep 5; done' || (docker compose -f config/docker/docker-compose.yml logs && exit 1)

      - name: Set up Python for tests
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Run API Integration Tests
        working-directory: ./backend
        continue-on-error: true
        env:
          SECRET_KEY: "test_secret_key_for_ci"
          DATABASE_URL: "sqlite+aiosqlite:///:memory:"
        run: |
          pip install pytest httpx pytest-asyncio
          # Run specific E2E tests that require running server
          pytest tests/test_e2e_video_analysis.py -v --tb=short

      - name: Dump Docker Logs on Failure
        if: failure()
        run: docker compose -f config/docker/docker-compose.yml logs

      - name: Teardown
        if: always()
        run: docker compose -f config/docker/docker-compose.yml down -v
